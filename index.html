// Storage functions function saveStreamsToStorage() {
localStorage.setItem('multistream_<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Multi-Stream Viewer</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
        min-height: 100vh;
        color: white;
        display: flex;
        flex-direction: column;
      }

      .app-container {
        display: flex;
        flex: 1;
        min-height: calc(100vh - 80px);
      }

      /* Sidebar Styles */
      .sidebar {
        width: 240px;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        border-right: 2px solid rgba(145, 70, 255, 0.3);
        display: flex;
        flex-direction: column;
        position: sticky;
        top: 80px;
        height: calc(100vh - 80px);
        overflow: hidden;
      }

      .sidebar-header {
        padding: 1rem;
        background: rgba(145, 70, 255, 0.2);
        border-bottom: 1px solid rgba(145, 70, 255, 0.3);
        font-weight: bold;
        font-size: 0.9rem;
        color: #9146ff;
      }

      .followed-channels {
        flex: 1;
        overflow-y: auto;
        padding: 0.5rem 0;
      }

      .channel-category {
        margin-bottom: 1rem;
      }

      .category-header {
        padding: 0.5rem 1rem;
        font-size: 0.8rem;
        font-weight: bold;
        color: #adadb8;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 0.5rem;
      }

      .channel-item {
        padding: 0.7rem 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.8rem;
        border-left: 3px solid transparent;
      }

      .channel-item:hover {
        background: rgba(145, 70, 255, 0.2);
        border-left-color: #9146ff;
      }

      .channel-item.live {
        background: rgba(255, 107, 107, 0.1);
      }

      .channel-item.live:hover {
        background: rgba(255, 107, 107, 0.2);
        border-left-color: #ff6b6b;
      }

      .channel-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid transparent;
      }

      .channel-item.live .channel-avatar {
        border-color: #ff6b6b;
        box-shadow: 0 0 10px rgba(255, 107, 107, 0.3);
      }

      .channel-info {
        flex: 1;
        min-width: 0;
      }

      .channel-name {
        font-weight: bold;
        font-size: 0.85rem;
        color: #efeff1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .channel-item.live .channel-name {
        color: #ff6b6b;
      }

      .channel-game {
        font-size: 0.75rem;
        color: #adadb8;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-top: 2px;
      }

      .channel-viewers {
        font-size: 0.7rem;
        color: #ff6b6b;
        font-weight: bold;
        margin-top: 2px;
      }

      .live-indicator {
        width: 8px;
        height: 8px;
        background: #ff6b6b;
        border-radius: 50%;
        animation: pulse 2s infinite;
        flex-shrink: 0;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.4;
        }
      }

      .offline-indicator {
        width: 8px;
        height: 8px;
        background: #adadb8;
        border-radius: 50%;
        flex-shrink: 0;
      }

      .main-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      .no-channels {
        text-align: center;
        padding: 2rem 1rem;
        color: #adadb8;
        font-size: 0.8rem;
        font-style: italic;
      }

      .refresh-button {
        margin: 1rem;
        padding: 0.6rem 1rem;
        background: linear-gradient(45deg, #9146ff, #772ce8);
        border: none;
        border-radius: 20px;
        color: white;
        font-size: 0.8rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .refresh-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(145, 70, 255, 0.4);
      }

      .refresh-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      /* Mobile responsive */
      @media (max-width: 1024px) {
        .sidebar {
          width: 200px;
        }
      }

      @media (max-width: 768px) {
        .app-container {
          flex-direction: column;
        }

        .sidebar {
          width: 100%;
          height: 200px;
          position: static;
          border-right: none;
          border-bottom: 2px solid rgba(145, 70, 255, 0.3);
        }

        .followed-channels {
          display: flex;
          overflow-x: auto;
          overflow-y: hidden;
          padding: 0.5rem;
        }

        .channel-category {
          display: flex;
          gap: 0.5rem;
          margin: 0;
          min-width: max-content;
        }

        .category-header {
          display: none;
        }

        .channel-item {
          min-width: 150px;
          flex-direction: column;
          text-align: center;
          padding: 0.5rem;
        }
      }

      .header {
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        padding: 1rem 2rem;
        border-bottom: 2px solid #9146ff;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 1000;
      }

      .logo {
        font-size: 1.8rem;
        font-weight: bold;
        color: #9146ff;
        text-shadow: 0 0 10px rgba(145, 70, 255, 0.5);
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .login-btn,
      .add-stream-btn {
        background: linear-gradient(45deg, #9146ff, #772ce8);
        border: none;
        padding: 0.7rem 1.5rem;
        border-radius: 25px;
        color: white;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
      }

      .login-btn:hover,
      .add-stream-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(145, 70, 255, 0.4);
      }

      .controls {
        padding: 1rem 2rem;
        background: rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(5px);
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
      }

      .input-container {
        flex: 1;
        min-width: 300px;
        position: relative;
      }

      .stream-input {
        width: 100%;
        padding: 0.7rem 1rem;
        border: 2px solid #9146ff;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        font-size: 1rem;
        transition: all 0.3s ease;
      }

      .stream-input:focus {
        outline: none;
        border-color: #772ce8;
        box-shadow: 0 0 15px rgba(145, 70, 255, 0.3);
      }

      .stream-input::placeholder {
        color: rgba(255, 255, 255, 0.6);
      }

      .suggestions-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(10px);
        border: 2px solid #9146ff;
        border-top: none;
        border-radius: 0 0 10px 10px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
      }

      .suggestion-item {
        padding: 0.8rem 1rem;
        cursor: pointer;
        border-bottom: 1px solid rgba(145, 70, 255, 0.2);
        display: flex;
        align-items: center;
        gap: 0.8rem;
        transition: all 0.2s ease;
      }

      .suggestion-item:hover,
      .suggestion-item.selected {
        background: rgba(145, 70, 255, 0.3);
        transform: translateX(5px);
      }

      .suggestion-item:last-child {
        border-bottom: none;
      }

      .suggestion-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
      }

      .suggestion-info {
        flex: 1;
      }

      .suggestion-name {
        font-weight: bold;
        color: #9146ff;
        font-size: 0.9rem;
      }

      .suggestion-game {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.7);
        margin-top: 2px;
      }

      .suggestion-viewers {
        font-size: 0.8rem;
        color: #ff6b6b;
        font-weight: bold;
      }

      .loading-suggestion {
        padding: 1rem;
        text-align: center;
        color: #9146ff;
        font-style: italic;
      }

      .main-content {
        padding: 2rem;
      }

      .streams-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        gap: 1.5rem;
        max-width: calc(4 * 500px);
        margin: 0 auto;
      }

      .stream-item {
        background: rgba(0, 0, 0, 0.4);
        border-radius: 15px;
        overflow: hidden;
        border: 2px solid transparent;
        transition: all 0.3s ease;
        position: relative;
        display: flex;
        flex-direction: column;
        height: fit-content;
      }

      .stream-item:hover {
        border-color: #9146ff;
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(145, 70, 255, 0.2);
      }

      .stream-header {
        padding: 1rem;
        background: rgba(145, 70, 255, 0.2);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .stream-title {
        font-weight: bold;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .lock-icon {
        color: #ffd700;
        font-size: 0.9rem;
        text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
      }

      .stream-controls {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: wrap;
      }

      .lock-btn {
        background: rgba(255, 215, 0, 0.2);
        border: 2px solid #ffd700;
        color: #ffd700;
        padding: 0.4rem 0.8rem;
        border-radius: 15px;
        cursor: pointer;
        font-size: 0.75rem;
        font-weight: bold;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.3rem;
        white-space: nowrap;
      }

      .lock-btn:hover {
        background: rgba(255, 215, 0, 0.3);
        transform: scale(1.05);
      }

      .lock-btn.locked {
        background: #ffd700;
        color: #000;
        box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
      }

      .lock-btn.locked:hover {
        background: #ffed4e;
      }

      .remove-btn {
        background: #ff4757;
        border: none;
        color: white;
        padding: 0.4rem 0.8rem;
        border-radius: 15px;
        cursor: pointer;
        font-size: 0.75rem;
        font-weight: bold;
        transition: all 0.3s ease;
      }

      .remove-btn:hover {
        background: #ff3838;
        transform: scale(1.05);
      }

      .remove-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .locked-streams-notice {
        background: rgba(255, 215, 0, 0.1);
        border: 1px solid rgba(255, 215, 0, 0.3);
        border-radius: 10px;
        padding: 0.8rem 1rem;
        margin-bottom: 1rem;
        font-size: 0.85rem;
        color: #ffd700;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .locked-streams-notice.hidden {
        display: none;
      }

      .stream-video-container {
        position: relative;
        width: 100%;
        aspect-ratio: 16 / 9;
        background: #000;
      }

      .stream-video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }

      .stream-chat {
        background: rgba(0, 0, 0, 0.6);
        height: 350px;
        display: flex;
        flex-direction: column;
        border-radius: 0 0 15px 15px;
      }

      .stream-chat iframe {
        width: 100%;
        height: 100%;
        border: none;
        border-radius: 0 0 15px 15px;
      }

      /* Lightbox Overlay Styles */
      .lightbox-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.95);
        backdrop-filter: blur(10px);
        z-index: 9999;
        display: none;
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.3s ease-out;
      }

      .lightbox-overlay.active {
        display: flex;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .lightbox-content {
        background: rgba(0, 0, 0, 0.8);
        border-radius: 20px;
        border: 3px solid #9146ff;
        box-shadow: 0 20px 60px rgba(145, 70, 255, 0.4);
        padding: 1.5rem;
        max-width: 90vw;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        position: relative;
        animation: slideUp 0.4s ease-out;
      }

      @keyframes slideUp {
        from {
          transform: translateY(50px) scale(0.9);
          opacity: 0;
        }
        to {
          transform: translateY(0) scale(1);
          opacity: 1;
        }
      }

      .lightbox-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid rgba(145, 70, 255, 0.3);
      }

      .lightbox-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #9146ff;
        text-shadow: 0 0 10px rgba(145, 70, 255, 0.5);
      }

      .lightbox-close {
        background: #ff4757;
        border: none;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        font-size: 1.2rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .lightbox-close:hover {
        background: #ff3838;
        transform: scale(1.1) rotate(90deg);
      }

      .lightbox-video-container {
        width: 80vw;
        max-width: 1200px;
        aspect-ratio: 16 / 9;
        margin-bottom: 1rem;
        border-radius: 10px;
        overflow: hidden;
        background: #000;
      }

      .lightbox-video {
        width: 100%;
        height: 100%;
      }

      .lightbox-controls {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
        padding: 1rem;
        background: rgba(0, 0, 0, 0.6);
        border-radius: 10px;
      }

      .lightbox-volume-label {
        color: #9146ff;
        font-weight: bold;
        min-width: 80px;
      }

      .lightbox-volume-slider {
        flex: 1;
        height: 8px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
        outline: none;
        -webkit-appearance: none;
      }

      .lightbox-volume-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 24px;
        height: 24px;
        background: #9146ff;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 0 15px rgba(145, 70, 255, 0.6);
      }

      .lightbox-volume-slider::-moz-range-thumb {
        width: 24px;
        height: 24px;
        background: #9146ff;
        border-radius: 50%;
        cursor: pointer;
        border: none;
        box-shadow: 0 0 15px rgba(145, 70, 255, 0.6);
      }

      .lightbox-chat {
        height: 400px;
        background: #0e0e10;
        border-radius: 10px;
        border: 2px solid rgba(145, 70, 255, 0.3);
        display: flex;
        flex-direction: column;
      }

      .lightbox-chat iframe {
        width: 100%;
        height: 100%;
        border: none;
        border-radius: 8px;
      }

      .stream-video-container {
        position: relative;
        cursor: pointer;
      }

      /* Mobile responsive for lightbox */
      @media (max-width: 768px) {
        .lightbox-content {
          margin: 1rem;
          padding: 1rem;
        }

        .lightbox-video-container {
          width: 90vw;
        }

        .lightbox-chat {
          height: 200px;
        }

        .lightbox-controls {
          flex-direction: column;
          align-items: stretch;
          gap: 0.5rem;
        }

        .lightbox-volume-label {
          min-width: auto;
          text-align: center;
        }
      }

      .volume-control {
        padding: 1rem;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .volume-slider {
        flex: 1;
        height: 6px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 3px;
        outline: none;
        -webkit-appearance: none;
      }

      .volume-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 20px;
        height: 20px;
        background: #9146ff;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 0 10px rgba(145, 70, 255, 0.5);
      }

      .volume-slider::-moz-range-thumb {
        width: 20px;
        height: 20px;
        background: #9146ff;
        border-radius: 50%;
        cursor: pointer;
        border: none;
        box-shadow: 0 0 10px rgba(145, 70, 255, 0.5);
      }

      .volume-label {
        font-size: 0.9rem;
        color: #9146ff;
        font-weight: bold;
        min-width: 60px;
      }

      .chat-container {
        width: 350px;
        background: rgba(0, 0, 0, 0.4);
        border-radius: 15px;
        border: 2px solid #9146ff;
        backdrop-filter: blur(10px);
        display: flex;
        flex-direction: column;
        max-height: 80vh;
      }

      .global-chat-header {
        padding: 1rem;
        background: rgba(145, 70, 255, 0.3);
        border-radius: 13px 13px 0 0;
        font-weight: bold;
        text-align: center;
      }

      .chat-messages {
        flex: 1;
        padding: 1rem;
        overflow-y: auto;
        max-height: 500px;
      }

      .chat-message {
        margin-bottom: 0.8rem;
        padding: 0.5rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        font-size: 0.9rem;
      }

      .message-author {
        font-weight: bold;
        color: #9146ff;
      }

      .no-streams {
        text-align: center;
        padding: 4rem 2rem;
        color: rgba(255, 255, 255, 0.6);
        font-size: 1.2rem;
      }

      .loading {
        text-align: center;
        padding: 2rem;
        color: #9146ff;
        font-size: 1.1rem;
      }

      @media (max-width: 1200px) {
        .streams-grid {
          grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
          max-width: none;
        }
      }

      @media (max-width: 768px) {
        .streams-grid {
          grid-template-columns: 1fr;
          max-width: none;
        }

        .controls {
          flex-direction: column;
          align-items: stretch;
        }

        .input-container {
          min-width: auto;
        }

        .stream-video-container {
          aspect-ratio: 16 / 9;
        }

        .stream-chat {
          height: 300px;
        }

        .lightbox-chat {
          height: 300px;
        }
      }

      .user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 2px solid #9146ff;
      }

      .username {
        color: #9146ff;
        font-weight: bold;
      }

      /* Scrollbar styling */
      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb {
        background: #9146ff;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #772ce8;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="logo">🎮 MultiStream</div>
      <div class="user-info" id="userInfo">
        <button class="login-btn" id="loginBtn" onclick="loginToTwitch()">
          🎮 Login with Twitch
        </button>
      </div>
    </div>

    <div class="app-container">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="sidebar-header">📺 Following</div>
        <div class="followed-channels" id="followedChannels">
          <div class="no-channels" id="noFollowedChannels">
            Login to see followed channels
          </div>
        </div>
        <button
          class="refresh-button"
          id="refreshButton"
          onclick="refreshFollowedChannels()"
        >
          🔄 Refresh
        </button>
      </div>

      <!-- Main Content -->
      <div class="main-wrapper">
        <div class="controls">
          <div class="input-container">
            <input
              type="text"
              class="stream-input"
              id="streamInput"
              placeholder="Search for Twitch channels..."
              autocomplete="off"
            />
            <div class="suggestions-dropdown" id="suggestionsDropdown"></div>
          </div>
          <button class="add-stream-btn" onclick="addStream()">
            Add Stream
          </button>
        </div>

        <div class="main-content">
          <div class="streams-grid" id="streamsGrid">
            <div class="no-streams" id="noStreams">
              No streams added yet. Add a Twitch channel to get started!
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Lightbox Overlay -->
    <div class="lightbox-overlay" id="lightboxOverlay">
      <div class="lightbox-content">
        <div class="lightbox-header">
          <div class="lightbox-title" id="lightboxTitle">Stream Focus</div>
          <button class="lightbox-close" onclick="closeLightbox()">✕</button>
        </div>

        <div class="lightbox-video-container">
          <iframe
            id="lightboxVideo"
            class="lightbox-video"
            frameborder="0"
            allowfullscreen="true"
            scrolling="no"
          >
          </iframe>
        </div>

        <div class="lightbox-controls">
          <span style="color: #9146ff; font-weight: bold"
            >💡 Use Twitch player controls for volume and settings</span
          >
        </div>

        <div class="lightbox-chat">
          <iframe id="lightboxChatFrame" src="" frameborder="0" scrolling="no">
          </iframe>
        </div>
      </div>
    </div>

    <script>
      // Twitch API configuration
      const CLIENT_ID = "6gc6nxubck1j20tumdvsl7ry72zlzd"; // Your registered Twitch app
      const REDIRECT_URI = window.location.origin;

      let streams = [];
      let user = null;
      let chatConnections = new Map();
      let searchTimeout = null;
      let selectedSuggestionIndex = -1;
      let currentSuggestions = [];
      let streamChats = new Map(); // Store chat messages per stream
      let currentLightboxStream = null;
      let followedChannels = []; // Store followed channels data

      // Initialize the app
      document.addEventListener("DOMContentLoaded", function () {
        checkAuthFromURL();
        loadStreamsFromStorage();
        updateUI();
        setupAutoSuggest();

        // Load demo followed channels initially (always show something)
        loadDemoFollowedChannels();
        updateFollowedChannelsUI();
      });

      // Twitch Authentication
      function loginToTwitch() {
        console.log("Using Client ID:", CLIENT_ID);
        console.log("Redirect URI:", window.location.origin);

        const authUrl =
          `https://id.twitch.tv/oauth2/authorize` +
          `?client_id=${CLIENT_ID}` +
          `&redirect_uri=${encodeURIComponent(window.location.origin)}` +
          `&response_type=token` +
          `&scope=user:read:email` +
          `&force_verify=true`;

        console.log("Full OAuth URL:", authUrl);
        window.location.href = authUrl;
      }

      function checkAuthFromURL() {
        const hash = window.location.hash.substr(1);
        const params = new URLSearchParams(hash);
        const accessToken = params.get("access_token");
        const error = params.get("error");
        const errorDescription = params.get("error_description");

        console.log("=== AUTH DEBUG ===");
        console.log("Full URL hash:", hash);
        console.log("Access token present:", !!accessToken);
        console.log(
          "Access token (first 10 chars):",
          accessToken ? accessToken.substring(0, 10) + "..." : "none"
        );
        console.log("OAuth error:", error);
        console.log("Error description:", errorDescription);
        console.log("Current domain:", window.location.origin);
        console.log("Client ID being used:", CLIENT_ID);

        if (error) {
          console.error("OAuth error details:", { error, errorDescription });
          alert(
            `Login failed: ${error}\n${
              errorDescription || "Please check your Twitch app settings."
            }`
          );
          return;
        }

        if (accessToken) {
          console.log("✅ Found access token, storing and fetching user data");
          localStorage.setItem("twitch_token", accessToken);
          window.location.hash = ""; // Clean URL
          fetchUserData(accessToken);
        } else {
          const storedToken = localStorage.getItem("twitch_token");
          if (storedToken) {
            console.log("📦 Using stored token");
            fetchUserData(storedToken);
          } else {
            console.log("❌ No token found, user not logged in");
          }
        }
      }

      async function fetchUserData(token) {
        console.log(
          "Fetching user data with token length:",
          token ? token.length : "missing"
        );

        try {
          console.log("Making API call to Twitch...");
          const response = await fetch("https://api.twitch.tv/helix/users", {
            headers: {
              Authorization: `Bearer ${token}`,
              "Client-Id": CLIENT_ID,
            },
          });

          console.log("API Response status:", response.status);
          console.log(
            "API Response headers:",
            Object.fromEntries(response.headers.entries())
          );

          if (response.status === 401) {
            console.error("401 Unauthorized - Token or Client ID issue");
            const errorData = await response.text();
            console.error("401 Error details:", errorData);

            localStorage.removeItem("twitch_token");
            alert(
              "Authentication failed: Invalid token or client ID. Please check your Twitch app configuration."
            );
            user = null;
            updateUserInfo();
            return;
          }

          if (response.ok) {
            const data = await response.json();
            console.log("✅ User data received successfully:", data);

            if (data.data && data.data.length > 0) {
              user = data.data[0];
              console.log("✅ User successfully set to:", user.display_name);
              updateUserInfo();
              // Load followed channels after successful user authentication
              if (typeof loadFollowedChannels === "function") {
                loadFollowedChannels();
              } else {
                console.log(
                  "loadFollowedChannels function not available, showing demo data"
                );
              }
              return;
            } else {
              console.error("❌ No user data in response");
            }
          } else {
            const errorText = await response.text();
            console.error("❌ API Error - Status:", response.status);
            console.error("❌ API Error - Details:", errorText);

            // Try to parse error for more details
            try {
              const errorJson = JSON.parse(errorText);
              console.error("❌ Parsed error:", errorJson);
            } catch (e) {
              console.error("❌ Could not parse error as JSON");
            }
          }

          throw new Error(`API returned status ${response.status}`);
        } catch (error) {
          console.error("❌ Network or API error:", error);
          localStorage.removeItem("twitch_token");

          alert(
            `Failed to get user information. Error: ${error.message}\n\nThis could be:\n- Client ID configuration issue\n- Network connectivity problem\n- Twitch API temporary issue\n\nCheck console for details.`
          );

          user = null;
          updateUserInfo();
        }
      }

      function updateUserInfo() {
        const userInfo = document.getElementById("userInfo");
        if (user) {
          console.log("Updating UI for user:", user.display_name);
          userInfo.innerHTML = `
                    <img src="${user.profile_image_url}" alt="Avatar" class="user-avatar">
                    <span class="username">${user.display_name}</span>
                    <button class="login-btn" onclick="logout()" style="background: #ff4757;">Logout</button>
                `;
          // Note: loadFollowedChannels() is now called from fetchUserData()
        } else {
          console.log("Clearing user info - user logged out");
          userInfo.innerHTML = `
                    <button class="login-btn" id="loginBtn" onclick="loginToTwitch()">🎮 Login with Twitch</button>
                `;
          // Clear followed channels when user logs out
          followedChannels = [];
          if (typeof updateFollowedChannelsUI === "function") {
            updateFollowedChannelsUI();
          } else {
            console.log("updateFollowedChannelsUI function not available");
          }
        }
      }

      function logout() {
        localStorage.removeItem("twitch_token");
        user = null;
        location.reload();
      }

      // Lightbox functionality
      function openLightbox(streamId) {
        console.log("Opening lightbox for stream ID:", streamId);
        const stream = streams.find((s) => s.id === streamId);
        if (!stream) {
          console.error("Stream not found:", streamId);
          return;
        }

        console.log("Found stream:", stream);
        currentLightboxStream = stream;

        // Update lightbox content
        document.getElementById(
          "lightboxTitle"
        ).textContent = `🎮 ${stream.channel}`;

        // Set up video iframe with unmuted parameter
        const lightboxVideo = document.getElementById("lightboxVideo");
        lightboxVideo.src = `https://player.twitch.tv/?channel=${stream.channel}&parent=${window.location.hostname}&muted=false&autoplay=true`;

        // Set up chat iframe
        const lightboxChatFrame = document.getElementById("lightboxChatFrame");
        lightboxChatFrame.src = `https://www.twitch.tv/embed/${stream.channel}/chat?parent=${window.location.hostname}`;

        // Mute all other streams by updating their iframes
        muteBackgroundStreams(streamId);

        // Show lightbox
        const overlay = document.getElementById("lightboxOverlay");
        overlay.classList.add("active");

        // Prevent body scroll
        document.body.style.overflow = "hidden";

        console.log("Lightbox opened successfully");
      }

      function closeLightbox() {
        const overlay = document.getElementById("lightboxOverlay");
        overlay.classList.remove("active");

        // Restore body scroll
        document.body.style.overflow = "auto";

        // Unmute all streams
        unmuteAllStreams();

        currentLightboxStream = null;
      }

      function muteBackgroundStreams(activeStreamId) {
        streams.forEach((stream) => {
          if (stream.id !== activeStreamId) {
            const iframe = document.querySelector(
              `[data-stream-id="${stream.id}"] iframe`
            );
            if (iframe) {
              // Update iframe src to include muted parameter
              iframe.src = `https://player.twitch.tv/?channel=${stream.channel}&parent=${window.location.hostname}&muted=true&autoplay=true`;
            }
          }
        });
      }

      function unmuteAllStreams() {
        streams.forEach((stream) => {
          const iframe = document.querySelector(
            `[data-stream-id="${stream.id}"] iframe`
          );
          if (iframe) {
            // Restore original unmuted state
            iframe.src = `https://player.twitch.tv/?channel=${stream.channel}&parent=${window.location.hostname}&muted=false&autoplay=true`;
          }
        });
      }

      function updateLightboxVolume(volume) {
        const volumeLabel = document.getElementById("lightboxVolumeLabel");
        volumeLabel.textContent = `🔊 ${volume}%`;

        if (currentLightboxStream) {
          currentLightboxStream.volume = parseInt(volume);
          saveStreamsToStorage();

          // Also update the main stream's volume display
          updateUI();
        }
      }

      function updateLightboxChat(channel) {
        const chatMessages = document.getElementById("lightboxChatMessages");
        const messages = streamChats.get(channel) || [];

        chatMessages.innerHTML = messages
          .map(
            (msg) => `
                <div class="chat-message">
                    <span class="message-author">${msg.author}:</span>
                    <span class="message-text">${msg.text}</span>
                </div>
            `
          )
          .join("");

        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function sendLightboxChatMessage() {
        const input = document.getElementById("lightboxChatInput");
        const message = input.value.trim();

        if (!message || !currentLightboxStream) return;

        sendChatMessage(currentLightboxStream.channel, message);
        input.value = "";
      }

      // Debug function to test your client ID
      window.testTwitchAPI = async function () {
        const token = localStorage.getItem("twitch_token");
        console.log("=== MANUAL API TEST ===");
        console.log("Client ID:", CLIENT_ID);
        console.log("Token present:", !!token);
        console.log("Token length:", token ? token.length : 0);

        if (!token) {
          console.log("❌ No token found. Please login first.");
          return;
        }

        try {
          // Test the exact same API call
          const response = await fetch("https://api.twitch.tv/helix/users", {
            headers: {
              Authorization: `Bearer ${token}`,
              "Client-Id": CLIENT_ID,
            },
          });

          console.log("Manual test response status:", response.status);

          if (response.ok) {
            const data = await response.json();
            console.log("✅ Manual test successful:", data);
          } else {
            const errorText = await response.text();
            console.log("❌ Manual test failed:", errorText);
          }
        } catch (error) {
          console.log("❌ Manual test error:", error);
        }
      };

      // Make functions globally available for debugging
      window.toggleStreamLock = toggleStreamLock;
      window.removeStream = removeStream;
      window.openLightbox = openLightbox;
      window.debugStreams = () => console.log("Current streams:", streams);

      // Close lightbox when clicking outside content
      document
        .getElementById("lightboxOverlay")
        .addEventListener("click", function (e) {
          if (e.target === this) {
            closeLightbox();
          }
        });

      // Close lightbox with Escape key
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape" && currentLightboxStream) {
          closeLightbox();
        }
      });
      function setupAutoSuggest() {
        const input = document.getElementById("streamInput");
        const dropdown = document.getElementById("suggestionsDropdown");

        input.addEventListener("input", function (e) {
          const query = e.target.value.trim();

          if (query.length < 2) {
            hideSuggestions();
            return;
          }

          // Clear previous timeout
          if (searchTimeout) {
            clearTimeout(searchTimeout);
          }

          // Debounce search requests
          searchTimeout = setTimeout(() => {
            searchChannels(query);
          }, 300);
        });

        input.addEventListener("keydown", function (e) {
          const dropdown = document.getElementById("suggestionsDropdown");
          if (dropdown.style.display === "none") return;

          switch (e.key) {
            case "ArrowDown":
              e.preventDefault();
              selectedSuggestionIndex = Math.min(
                selectedSuggestionIndex + 1,
                currentSuggestions.length - 1
              );
              updateSuggestionSelection();
              break;
            case "ArrowUp":
              e.preventDefault();
              selectedSuggestionIndex = Math.max(
                selectedSuggestionIndex - 1,
                -1
              );
              updateSuggestionSelection();
              break;
            case "Enter":
              e.preventDefault();
              if (
                selectedSuggestionIndex >= 0 &&
                currentSuggestions[selectedSuggestionIndex]
              ) {
                selectSuggestion(currentSuggestions[selectedSuggestionIndex]);
              } else {
                addStream();
              }
              break;
            case "Escape":
              hideSuggestions();
              break;
          }
        });

        input.addEventListener("blur", function () {
          // Delay hiding to allow click on suggestions
          setTimeout(() => hideSuggestions(), 150);
        });
      }

      async function searchChannels(query) {
        const dropdown = document.getElementById("suggestionsDropdown");

        // Show loading state
        dropdown.innerHTML =
          '<div class="loading-suggestion">🔍 Searching channels...</div>';
        dropdown.style.display = "block";

        try {
          const token = localStorage.getItem("twitch_token");
          if (!token) {
            // Fallback to popular streamers if not authenticated
            showPopularChannels(query);
            return;
          }

          const response = await fetch(
            `https://api.twitch.tv/helix/search/channels?query=${encodeURIComponent(
              query
            )}&first=10&live_only=true`,
            {
              headers: {
                Authorization: `Bearer ${token}`,
                "Client-Id": CLIENT_ID,
              },
            }
          );

          if (response.ok) {
            const data = await response.json();
            currentSuggestions = data.data;
            displaySuggestions(data.data);
          } else {
            console.error("Search failed:", response.status);
            showPopularChannels(query);
          }
        } catch (error) {
          console.error("Search error:", error);
          showPopularChannels(query);
        }
      }

      function showPopularChannels(query) {
        // Fallback list of popular streamers for demo purposes
        const popularChannels = [
          {
            broadcaster_name: "ninja",
            display_name: "Ninja",
            game_name: "Fortnite",
            thumbnail_url:
              "https://static-cdn.jtvnw.net/jtv_user_pictures/ninja-profile_image-6c7353c6142f9f26-300x300.png",
          },
          {
            broadcaster_name: "pokimane",
            display_name: "Pokimane",
            game_name: "Just Chatting",
            thumbnail_url:
              "https://static-cdn.jtvnw.net/jtv_user_pictures/pokimane-profile_image-4de9767e2b2af4b3-300x300.png",
          },
          {
            broadcaster_name: "shroud",
            display_name: "shroud",
            game_name: "VALORANT",
            thumbnail_url:
              "https://static-cdn.jtvnw.net/jtv_user_pictures/shroud-profile_image-7ca02ca7498710fc-300x300.png",
          },
          {
            broadcaster_name: "xqc",
            display_name: "xQc",
            game_name: "Grand Theft Auto V",
            thumbnail_url:
              "https://static-cdn.jtvnw.net/jtv_user_pictures/xqc-profile_image-9298dca608632101-300x300.png",
          },
          {
            broadcaster_name: "summit1g",
            display_name: "summit1g",
            game_name: "Counter-Strike 2",
            thumbnail_url:
              "https://static-cdn.jtvnw.net/jtv_user_pictures/summit1g-profile_image-4c3b6e17f40c6e8b-300x300.png",
          },
          {
            broadcaster_name: "lirik",
            display_name: "LIRIK",
            game_name: "Variety",
            thumbnail_url:
              "https://static-cdn.jtvnw.net/jtv_user_pictures/lirik-profile_image-5b0f84b85dd2edf2-300x300.png",
          },
        ];

        const filtered = popularChannels.filter(
          (channel) =>
            channel.display_name.toLowerCase().includes(query.toLowerCase()) ||
            channel.broadcaster_name.toLowerCase().includes(query.toLowerCase())
        );

        currentSuggestions = filtered;
        displaySuggestions(filtered);
      }

      function displaySuggestions(channels) {
        const dropdown = document.getElementById("suggestionsDropdown");
        selectedSuggestionIndex = -1;

        if (channels.length === 0) {
          dropdown.innerHTML =
            '<div class="loading-suggestion">No channels found</div>';
          return;
        }

        dropdown.innerHTML = channels
          .map(
            (channel, index) => `
                <div class="suggestion-item" onclick="selectSuggestion(currentSuggestions[${index}])" data-index="${index}">
                    <img src="${
                      channel.thumbnail_url ||
                      "https://static-cdn.jtvnw.net/user-default-pictures-uv/cdd517fe-def4-11e9-948e-784f43822e80-profile_image-300x300.png"
                    }" 
                         alt="${
                           channel.display_name
                         }" class="suggestion-avatar">
                    <div class="suggestion-info">
                        <div class="suggestion-name">${
                          channel.display_name
                        }</div>
                        <div class="suggestion-game">${
                          channel.game_name || "No category"
                        }</div>
                    </div>
                    ${
                      channel.is_live !== false
                        ? '<span class="suggestion-viewers">🔴 LIVE</span>'
                        : ""
                    }
                </div>
            `
          )
          .join("");

        dropdown.style.display = "block";
      }

      function updateSuggestionSelection() {
        const items = document.querySelectorAll(".suggestion-item");
        items.forEach((item, index) => {
          item.classList.toggle("selected", index === selectedSuggestionIndex);
        });
      }

      function selectSuggestion(channel) {
        const input = document.getElementById("streamInput");
        input.value =
          channel.broadcaster_name || channel.display_name.toLowerCase();
        hideSuggestions();
        addStream();
      }

      function hideSuggestions() {
        const dropdown = document.getElementById("suggestionsDropdown");
        dropdown.style.display = "none";
        selectedSuggestionIndex = -1;
        currentSuggestions = [];
      }
      // Stream Management
      function addStream() {
        const input = document.getElementById("streamInput");
        const channelName = input.value.trim().toLowerCase();

        if (!channelName) {
          alert("Please enter a channel name");
          return;
        }

        if (streams.find((s) => s.channel === channelName)) {
          alert("This stream is already added");
          return;
        }

        const stream = {
          id: Date.now(),
          channel: channelName,
          locked: false,
        };

        streams.push(stream);
        input.value = "";
        hideSuggestions();

        saveStreamsToStorage();
        updateUI();
      }

      function removeStream(streamId) {
        const stream = streams.find((s) => s.id === streamId);
        if (!stream) return;

        // Confirm removal if stream is locked
        if (stream.locked) {
          const confirmRemove = confirm(
            `"${stream.channel}" is locked. Are you sure you want to remove it?`
          );
          if (!confirmRemove) return;
        }

        streams = streams.filter((s) => s.id !== streamId);
        saveStreamsToStorage();
        updateUI();
      }

      function toggleStreamLock(streamId) {
        const stream = streams.find((s) => s.id === streamId);
        if (!stream) return;

        stream.locked = !stream.locked;
        saveStreamsToStorage();
        updateUI();

        // Show feedback
        const lockBtn = document.querySelector(`[data-lock-btn="${streamId}"]`);
        if (lockBtn) {
          const originalText = lockBtn.innerHTML;
          lockBtn.innerHTML = stream.locked
            ? "🔓➜🔒 Locked!"
            : "🔒➜🔓 Unlocked!";
          setTimeout(() => {
            lockBtn.innerHTML = originalText;
          }, 1500);
        }
      }

      // Chat functionality
      function connectToChat(channel) {
        // Initialize chat storage for this stream
        if (!streamChats.has(channel)) {
          streamChats.set(channel, []);
        }

        // In a real implementation, you'd connect to Twitch IRC
        // For demo purposes, we'll simulate chat messages
        simulateChat(channel);
      }

      function simulateChat(channel) {
        const messages = [
          { author: "Viewer1", text: `Hello from ${channel}'s chat!` },
          { author: "Viewer2", text: "Great stream!" },
          { author: "Viewer3", text: "PogChamp" },
          { author: "Viewer4", text: "Amazing gameplay" },
          { author: "ModeratorBot", text: "Welcome to the stream!" },
          { author: "StreamFan", text: "LUL" },
          { author: "ChatBot", text: "Don't forget to follow!" },
          { author: "Viewer5", text: "KEKW" },
          { author: "Viewer6", text: "EZ Clap" },
          { author: "Viewer7", text: "This is so good!" },
        ];

        let messageIndex = 0;
        const chatInterval = setInterval(() => {
          if (messageIndex >= messages.length) {
            messageIndex = 0;
          }

          const message = messages[messageIndex];
          addChatMessageToStream(channel, message.author, message.text);
          messageIndex++;

          // Stop simulation if stream is removed
          if (!streams.find((s) => s.channel === channel)) {
            clearInterval(chatInterval);
          }
        }, 2000 + Math.random() * 4000);
      }

      function addChatMessageToStream(channel, author, text) {
        // Add to stored messages
        if (!streamChats.has(channel)) {
          streamChats.set(channel, []);
        }

        const messages = streamChats.get(channel);
        messages.push({ author, text, timestamp: Date.now() });

        // Keep only the last 50 messages per stream
        if (messages.length > 50) {
          messages.splice(0, messages.length - 50);
        }

        // Update the chat UI for this stream
        updateStreamChatUI(channel);

        // Update lightbox chat if this stream is currently focused
        if (
          currentLightboxStream &&
          currentLightboxStream.channel === channel
        ) {
          updateLightboxChat(channel);
        }
      }

      function updateStreamChatUI(channel) {
        const chatElement = document.querySelector(
          `[data-chat-channel="${channel}"]`
        );
        if (!chatElement) return;

        const messages = streamChats.get(channel) || [];
        chatElement.innerHTML = messages
          .map(
            (msg) => `
                <div class="chat-message">
                    <span class="message-author">${msg.author}:</span>
                    <span class="message-text">${msg.text}</span>
                </div>
            `
          )
          .join("");

        chatElement.scrollTop = chatElement.scrollHeight;
      }

      function sendChatMessage(channel, message) {
        if (!user) {
          alert("Please log in to chat");
          return;
        }

        if (!message.trim()) return;

        // In a real implementation, you'd send this to Twitch IRC
        // For demo, we'll just add it locally
        addChatMessageToStream(channel, user.display_name, message);

        // Clear the input
        const input = document.querySelector(`[data-chat-input="${channel}"]`);
        if (input) {
          input.value = "";
        }
      }

      // UI Updates
      function updateUI() {
        const streamsGrid = document.getElementById("streamsGrid");

        if (streams.length === 0) {
          streamsGrid.innerHTML =
            '<div class="no-streams">No streams added yet. Add a Twitch channel to get started!</div>';
          return;
        }

        streamsGrid.innerHTML = "";

        streams.forEach((stream) => {
          const streamDiv = document.createElement("div");
          streamDiv.className = "stream-item";
          streamDiv.innerHTML = `
                    <div class="stream-header">
                        <span class="stream-title">${stream.channel}</span>
                        <button class="remove-btn" onclick="event.stopPropagation(); removeStream(${
                          stream.id
                        })">Remove</button>
                    </div>
                    <div class="stream-video-container" data-stream-id="${
                      stream.id
                    }">
                        <iframe 
                            src="https://player.twitch.tv/?channel=${
                              stream.channel
                            }&parent=${
            window.location.hostname
          }&muted=false&autoplay=true"
                            class="stream-video"
                            frameborder="0"
                            allowfullscreen="true"
                            scrolling="no">
                        </iframe>
                    </div>
                    <div class="volume-control">
                        <span class="volume-label">🔊 ${stream.volume}%</span>
                        <input 
                            type="range" 
                            min="0" 
                            max="100" 
                            value="${stream.volume}"
                            class="volume-slider"
                            onchange="updateVolume(${stream.id}, this.value)"
                            oninput="this.parentElement.querySelector('.volume-label').textContent = '🔊 ' + this.value + '%'"
                        >
                    </div>
                    <div class="stream-chat">
                        <div class="chat-header">💬 ${stream.channel} Chat</div>
                        <div class="chat-messages" data-chat-channel="${
                          stream.channel
                        }">
                            <div class="chat-message system-message">
                                <span class="message-timestamp">${new Date().toLocaleTimeString(
                                  "en-US",
                                  {
                                    hour12: false,
                                    hour: "2-digit",
                                    minute: "2-digit",
                                  }
                                )}</span>
                                <span class="message-text">Welcome to ${
                                  stream.channel
                                }'s chat!</span>
                            </div>
                        </div>
                        ${
                          user
                            ? `
                            <div class="chat-input-container">
                                <input 
                                    type="text" 
                                    class="chat-input" 
                                    data-chat-input="${stream.channel}"
                                    placeholder="Type a message..."
                                    onkeypress="if(event.key==='Enter') sendChatMessage('${stream.channel}', this.value)"
                                    maxlength="500"
                                >
                            </div>
                        `
                            : `
                            <div class="login-prompt">
                                Login with Twitch to chat
                            </div>
                        `
                        }
                    </div>
                `;

          // Add click event to the video container
          const videoContainer = streamDiv.querySelector(
            ".stream-video-container"
          );
          console.log(
            "Adding click handler to video container for stream:",
            stream.id
          );
          videoContainer.addEventListener("click", function (e) {
            console.log(
              "Video container clicked, opening lightbox for:",
              stream.id
            );
            e.preventDefault();
            e.stopPropagation();
            openLightbox(stream.id);
          });
          streamsGrid.appendChild(streamDiv);

          // Initialize chat for this stream
          updateStreamChatUI(stream.channel);
        });
      }

      // Storage functions
      function saveStreamsToStorage() {
        localStorage.setItem("multistream_data", JSON.stringify(streams));
      }

      function loadStreamsFromStorage() {
        const stored = localStorage.getItem("multistream_data");
        if (stored) {
          const parsedStreams = JSON.parse(stored);

          // Migrate old streams without locked property and remove volume
          streams = parsedStreams.map((stream) => ({
            id: stream.id,
            channel: stream.channel,
            locked: stream.locked || false,
          }));

          // Show notification if locked streams were restored
          const lockedCount = streams.filter((s) => s.locked).length;
          if (lockedCount > 0) {
            setTimeout(() => {
              const notice = document.querySelector(".locked-streams-notice");
              if (notice) {
                notice.style.background = "rgba(76, 175, 80, 0.2)";
                notice.style.borderColor = "rgba(76, 175, 80, 0.5)";
                notice.style.color = "#4caf50";
                notice.innerHTML = `🔒✅ ${lockedCount} locked stream${
                  lockedCount > 1 ? "s" : ""
                } restored from previous session`;

                setTimeout(() => {
                  notice.style.background = "rgba(255, 215, 0, 0.1)";
                  notice.style.borderColor = "rgba(255, 215, 0, 0.3)";
                  notice.style.color = "#ffd700";
                  notice.innerHTML = `🔒 ${lockedCount} stream${
                    lockedCount > 1 ? "s" : ""
                  } locked - will persist after page refresh`;
                }, 3000);
              }
            }, 1000);
          }
        }
      }

      // Handle clicks outside to close suggestions
      document.addEventListener("click", function (e) {
        const inputContainer = document.querySelector(".input-container");
        if (!inputContainer.contains(e.target)) {
          hideSuggestions();
        }
      });
    </script>
  </body>
</html>
