<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Multi-Stream Viewer</title>
    <style>
      /* --- your CSS unchanged --- */
    </style>
  </head>
  <body>
    <div class="header">
      <div class="logo">üéÆ MultiStream</div>
      <div class="user-info" id="userInfo">
        <button class="login-btn" id="loginBtn" onclick="loginToTwitch()">
          üéÆ Login with Twitch
        </button>
      </div>
    </div>

    <div class="app-container">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="sidebar-header">üì∫ Following</div>
        <div class="followed-channels" id="followedChannels">
          <div class="no-channels" id="noFollowedChannels">
            Login to see followed channels
          </div>
        </div>
        <button
          class="refresh-button"
          id="refreshButton"
          onclick="refreshFollowedChannels()"
        >
          üîÑ Refresh
        </button>
        <button
          class="refresh-button"
          id="loadMoreButton"
          style="display: none"
          onclick="loadMoreFollowedChannels()"
        >
          üì• Load More
        </button>
      </div>

      <!-- Main Content -->
      <div class="main-wrapper">
        <div class="controls">
          <div class="input-container">
            <input
              type="text"
              class="stream-input"
              id="streamInput"
              placeholder="Search for Twitch channels..."
              autocomplete="off"
            />
            <div class="suggestions-dropdown" id="suggestionsDropdown"></div>
          </div>
          <button class="add-stream-btn" onclick="addStream()">
            Add Stream
          </button>
        </div>

        <div class="main-content">
          <div class="streams-grid" id="streamsGrid">
            <div class="no-streams" id="noStreams">
              No streams added yet. Add a Twitch channel to get started!
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Twitch API configuration
      const CLIENT_ID = "6gc6nxubck1j20tumdvsl7ry72zlzd";
      const REDIRECT_URI = window.location.origin;

      let streams = [];
      let user = null;
      let followedChannels = [];
      let paginationCursor = null; // for /channels/followed pagination

      // Helper: split array into chunks of N
      function chunkArray(arr, size) {
        const chunks = [];
        for (let i = 0; i < arr.length; i += size) {
          chunks.push(arr.slice(i, i + size));
        }
        return chunks;
      }

      document.addEventListener("DOMContentLoaded", function () {
        checkAuthFromURL();
        loadStreamsFromStorage();
        updateUI();
        setupAutoSuggest();
        loadDemoFollowedChannels();
        updateFollowedChannelsUI();
      });

      // Twitch Authentication
      function loginToTwitch() {
        const authUrl =
          `https://id.twitch.tv/oauth2/authorize` +
          `?client_id=${CLIENT_ID}` +
          `&redirect_uri=${encodeURIComponent(window.location.origin)}` +
          `&response_type=token` +
          `&scope=user:read:email user:read:follows` +
          `&force_verify=true`;

        window.location.href = authUrl;
      }

      function checkAuthFromURL() {
        const hash = window.location.hash.substr(1);
        const params = new URLSearchParams(hash);
        const accessToken = params.get("access_token");
        const error = params.get("error");

        if (error) {
          alert(`Login failed: ${error}`);
          return;
        }

        if (accessToken) {
          localStorage.setItem("twitch_token", accessToken);
          window.location.hash = "";
          fetchUserData(accessToken);
        } else {
          const storedToken = localStorage.getItem("twitch_token");
          if (storedToken) {
            fetchUserData(storedToken);
          }
        }
      }

      async function fetchUserData(token) {
        try {
          const response = await fetch("https://api.twitch.tv/helix/users", {
            headers: {
              Authorization: `Bearer ${token}`,
              "Client-Id": CLIENT_ID,
            },
          });

          if (response.ok) {
            const data = await response.json();
            if (data.data && data.data.length > 0) {
              user = data.data[0];
              updateUserInfo();
              fetchRealFollowedChannels(true); // load first page
            }
          } else {
            localStorage.removeItem("twitch_token");
          }
        } catch (error) {
          console.error("Error fetching user data:", error);
          localStorage.removeItem("twitch_token");
        }
      }

      async function fetchRealFollowedChannels(reset = false) {
        if (!user) return;

        const refreshButton = document.getElementById("refreshButton");
        refreshButton.disabled = true;
        refreshButton.textContent = "üîÑ Loading...";

        const token = localStorage.getItem("twitch_token");
        if (reset) {
          paginationCursor = null;
          followedChannels = [];
        }

        try {
          let url = `https://api.twitch.tv/helix/channels/followed?user_id=${user.id}&first=100`;
          if (paginationCursor) url += `&after=${paginationCursor}`;

          const followsResponse = await fetch(url, {
            headers: {
              Authorization: `Bearer ${token}`,
              "Client-Id": CLIENT_ID,
            },
          });

          if (!followsResponse.ok) {
            throw new Error(`Follows API returned ${followsResponse.status}`);
          }

          const followsData = await followsResponse.json();
          paginationCursor = followsData.pagination?.cursor || null;

          const channelIds = followsData.data.map((f) => f.broadcaster_id);

          // Fetch user info
          const usersResponse = await fetch(
            `https://api.twitch.tv/helix/users?${channelIds
              .map((id) => `id=${id}`)
              .join("&")}`,
            {
              headers: {
                Authorization: `Bearer ${token}`,
                "Client-Id": CLIENT_ID,
              },
            }
          );
          const usersData = await usersResponse.json();

          // Fetch streams in chunks of 100
          let streamsData = { data: [] };
          const idChunks = chunkArray(channelIds, 100);
          for (const chunk of idChunks) {
            const res = await fetch(
              `https://api.twitch.tv/helix/streams?${chunk
                .map((id) => `user_id=${id}`)
                .join("&")}`,
              {
                headers: {
                  Authorization: `Bearer ${token}`,
                  "Client-Id": CLIENT_ID,
                },
              }
            );
            if (res.ok) {
              const json = await res.json();
              streamsData.data.push(...json.data);
            }
          }

          // Merge
          const newChannels = usersData.data.map((channel) => {
            const liveStream = streamsData.data.find(
              (stream) => stream.user_id === channel.id
            );
            return {
              id: channel.id,
              login: channel.login,
              display_name: channel.display_name,
              profile_image_url: channel.profile_image_url,
              is_live: !!liveStream,
              game_name: liveStream?.game_name || "Offline",
              viewer_count: liveStream?.viewer_count || 0,
              title: liveStream?.title || "",
            };
          });

          followedChannels.push(...newChannels);
          updateFollowedChannelsUI();

          // Show/hide load more button
          document.getElementById("loadMoreButton").style.display =
            paginationCursor ? "block" : "none";
        } catch (err) {
          console.error("‚ùå Error fetching follows:", err);
        }

        refreshButton.disabled = false;
        refreshButton.textContent = "üîÑ Refresh";
      }

      function loadMoreFollowedChannels() {
        fetchRealFollowedChannels(false);
      }

      function updateUserInfo() {
        const userInfo = document.getElementById("userInfo");
        if (user) {
          userInfo.innerHTML = `
            <img src="${user.profile_image_url}" alt="Avatar" class="user-avatar">
            <span class="username">${user.display_name}</span>
            <button class="login-btn" onclick="logout()" style="background: #ff4757;">Logout</button>
          `;
        } else {
          userInfo.innerHTML = `<button class="login-btn" onclick="loginToTwitch()">üéÆ Login with Twitch</button>`;
          followedChannels = [];
          updateFollowedChannelsUI();
        }
      }

      function logout() {
        localStorage.removeItem("twitch_token");
        user = null;
        location.reload();
      }

      // --- existing functions for UI, streams, sidebar etc remain unchanged ---
      // (updateFollowedChannelsUI, createChannelHTML, addStream, updateUI, etc.)
    </script>
  </body>
</html>
